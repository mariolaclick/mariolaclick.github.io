<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Project Gantt Chart</title>
    
    <!-- Include Google Charts library -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
      }
      
      #chart_div {
        width: 100%;
        height: auto;
        min-height: 500px;
        margin-top: 20px;
      }
      
      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 20px;
      }
      
      .legend-item {
        display: flex;
        align-items: center;
      }
      
      .legend-color {
        width: 15px;
        height: 15px;
        margin-right: 8px;
        border-radius: 2px;
      }
      
      .header {
        margin-bottom: 20px;
      }
      
      h1 {
        color: #333;
        margin-bottom: 10px;
      }
      
      .task-tooltip {
        padding: 10px;
        border-radius: 4px;
        background-color: #f8f9fa;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
    </style>
  </head>
  
  <body>
    <div class="header">
      <h1>Project Gantt Chart</h1>
      <p>Live data from Google Sheets</p>
    </div>
    
    <div id="chart_div"></div>
    
    <div class="legend">
      <!-- Legend will be populated by JavaScript -->
    </div>
    
    <script>
      // Load Google Charts
      google.charts.load('current', {'packages':['gantt']});
      google.charts.setOnLoadCallback(drawChart);
      
      // Function to draw the Gantt chart
      function drawChart() {
        // Call the Apps Script function to get data
        google.script.run.withSuccessHandler(function(data) {
          
          // Create the data table
          var dataTable = new google.visualization.DataTable();
          dataTable.addColumn('string', 'Task ID');
          dataTable.addColumn('string', 'Task Name');
          dataTable.addColumn('string', 'Resource');
          dataTable.addColumn('date', 'Start Date');
          dataTable.addColumn('date', 'End Date');
          dataTable.addColumn('number', 'Duration');
          dataTable.addColumn('number', 'Percent Complete');
          dataTable.addColumn('string', 'Dependencies');
          
          // Map the categories to colors and build the legend
          var categories = {};
          var legendContainer = document.querySelector('.legend');
          legendContainer.innerHTML = '';
          
          // Process the data
          var rows = [];
          data.forEach(function(task, index) {
            // Convert weeks to dates (assuming each week is 7 days)
            var startDate = new Date(2025, 0, task['Start Week'] * 7);
            var endDate = new Date(2025, 0, task['End Week'] * 7 + 6); // End of the week
            
            // Add task to data table
            rows.push([
              'task' + index,
              task['Task'],
              task['Priority'],
              startDate,
              endDate,
              null,
              100, // 100% complete for all tasks for simplicity
              task['Helper'] > 0 ? 'task' + (index-1) : null // Simple dependency based on helper column
            ]);
            
            // Add to categories for the legend
            if (!categories[task['Category']]) {
              categories[task['Category']] = task['Color'];
              
              // Add to legend
              var legendItem = document.createElement('div');
              legendItem.className = 'legend-item';
              
              var colorBox = document.createElement('div');
              colorBox.className = 'legend-color';
              colorBox.style.backgroundColor = task['Color'];
              
              var label = document.createElement('span');
              label.textContent = task['Category'];
              
              legendItem.appendChild(colorBox);
              legendItem.appendChild(label);
              legendContainer.appendChild(legendItem);
            }
          });
          
          dataTable.addRows(rows);
          
          // Set chart options
          var options = {
            height: data.length * 40 + 50, // Adjust height based on number of tasks
            gantt: {
              trackHeight: 30,
              barHeight: 20,
              labelStyle: {
                fontName: 'Arial',
                fontSize: 13
              },
              barCornerRadius: 3,
              shadowEnabled: true
            }
          };
          
          // Create the chart
          var chart = new google.visualization.Gantt(document.getElementById('chart_div'));
          chart.draw(dataTable, options);
          
        }).getData(); // Call the Apps Script function to get data
      }
      
      // Function to refresh data every 5 minutes
      setInterval(drawChart, 300000);
    </script>
  </body>
</html>